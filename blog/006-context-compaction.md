---
title: "Agent å¦‚ä½•ã€Œæˆ˜ç•¥æ€§é—å¿˜ã€ï¼šä¸‰å±‚ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶è§£æ"
description: "ä¸Šä¸‹æ–‡çª—å£æ˜¯ AI Agent çš„ã€Œå·¥ä½œè®°å¿†ã€ï¼Œç”¨å®Œå°±å¡æ­»ã€‚æœ¬æ–‡è§£æ v5_agent.py ä¸­çš„ä¸‰å±‚å‹ç¼©æµæ°´çº¿â€”â€”micro_compactã€auto_compactã€compact å·¥å…·â€”â€”æ¯ä¸€å±‚è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œä»¥åŠè¿˜æœ‰å“ªäº›å‹ç¼©æ–¹å‘å€¼å¾—æ¢ç´¢ã€‚"
image: "/images/blog/context-compaction.jpg"
keywords:
  - Claude Code
  - AI Agent
  - Context Compaction
  - Context Window
  - Anthropic
tags:
  - Agent
  - Context
  - Memory
  - Implementation
author: "manus-learn"
date: "2026-02-23"
last_modified_at: "2026-02-23"
lang: "zh-CN"
audience: "å¼€å‘è€… / å¯¹ AI Agent æ„Ÿå…´è¶£çš„å·¥ç¨‹å¸ˆ"
difficulty: "intermediate"
estimated_read_time: "12-15min"
topics:
  - Context Window
  - Three-layer Compaction
  - Strategic Forgetting
  - Agent Memory Management
series: "ä»é›¶æ„å»º Claude Code"
series_order: 6
---

# æ„å»ºmini Claude Codeï¼š06 - Agent å¦‚ä½•ã€Œæˆ˜ç•¥æ€§é—å¿˜ã€

## ğŸ“ å¯¼èˆªæŒ‡å—

è¿™æ˜¯ã€Œä»é›¶æ„å»º Claude Codeã€ç³»åˆ—çš„ç¬¬å…­ç¯‡ã€‚æ ¹æ®ä½ çš„èƒŒæ™¯ï¼Œé€‰æ‹©åˆé€‚çš„é˜…è¯»è·¯å¾„ï¼š

- ğŸ§  **ç†è®ºæ´¾ï¼Ÿ** â†’ [ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸Šä¸‹æ–‡çª—å£çš„æœ¬è´¨é—®é¢˜](#part-1) - ç†è§£ä¸ºä»€ä¹ˆ Agent ä¼šã€Œæ’‘æ­»ã€
- âš™ï¸ **å®è·µæ´¾ï¼Ÿ** â†’ [ç¬¬äºŒéƒ¨åˆ†ï¼šä¸‰å±‚å‹ç¼©æµæ°´çº¿](#part-2) - æŒæ¡æ¯å±‚å‹ç¼©çš„è®¾è®¡é€»è¾‘
- ğŸ’» **ä»£ç æ´¾ï¼Ÿ** â†’ [ç¬¬ä¸‰éƒ¨åˆ†ï¼šä»£ç å®ç°](#part-3) - ç›´æ¥çœ‹å®Œæ•´å®ç°
- ğŸ”­ **æ¢ç´¢æ´¾ï¼Ÿ** â†’ [ç¬¬å››éƒ¨åˆ†ï¼šå…¶ä»–å‹ç¼©æ–¹å‘](#part-4) - è¿˜æœ‰å“ªäº›æ€è·¯å€¼å¾—å°è¯•

---

## ç›®å½•

### ç¬¬ä¸€éƒ¨åˆ†ï¼šç†è®ºåŸºç¡€ ğŸ§ 
- [ä¸Šä¸‹æ–‡çª—å£ï¼šAgent çš„å·¥ä½œè®°å¿†](#context-window)
- [ä¸ºä»€ä¹ˆ Agent ä¼šã€Œæ’‘æ­»ã€](#why-agents-die)
- [æˆ˜ç•¥æ€§é—å¿˜ï¼šæ ¸å¿ƒè®¾è®¡æ€æƒ³](#strategic-forgetting)

### ç¬¬äºŒéƒ¨åˆ†ï¼šä¸‰å±‚å‹ç¼©æµæ°´çº¿ âš™ï¸
- [æ•´ä½“æ¶æ„ï¼šä¸‰å±‚æµæ°´çº¿](#pipeline)
- [ç¬¬ä¸€å±‚ï¼šmicro_compactï¼ˆé™é»˜æ¸…ç†ï¼‰](#layer1)
- [ç¬¬äºŒå±‚ï¼šauto_compactï¼ˆè‡ªåŠ¨æ‘˜è¦ï¼‰](#layer2)
- [ç¬¬ä¸‰å±‚ï¼šcompact å·¥å…·ï¼ˆä¸»åŠ¨è§¦å‘ï¼‰](#layer3)
- [ä¸‰å±‚åä½œï¼šå„å¸å…¶èŒ](#cooperation)

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šä»£ç å®ç° ğŸ’»
- [token ä¼°ç®—](#token-estimate)
- [micro_compact å®ç°](#micro-compact-code)
- [auto_compact å®ç°](#auto-compact-code)
- [ä¸»å¾ªç¯ä¸­çš„å‹ç¼©è°ƒåº¦](#main-loop)

### ç¬¬å››éƒ¨åˆ†ï¼šå…¶ä»–å‹ç¼©æ–¹å‘ ğŸ”­
- [ç»“æ„åŒ–è®°å¿†æå–](#structured-memory)
- [å·¥å…·ç»“æœå»é‡](#dedup)
- [åˆ†å±‚å­˜å‚¨ï¼šçƒ­/å†·æ•°æ®åˆ†ç¦»](#tiered-storage)
- [è¯­ä¹‰å‹ç¼©](#semantic-compression)

### é™„å½•
- [å¸¸è§é—®é¢˜ FAQ](#faq)

---

## å¼•è¨€

æƒ³è±¡ä¸€ä¸ªç¨‹åºå‘˜åœ¨å¤„ç†ä¸€ä¸ªå¤æ‚ä»»åŠ¡ï¼šä»–æ‰“å¼€äº† 20 ä¸ªæ–‡ä»¶ï¼Œè¿è¡Œäº† 30 æ¡å‘½ä»¤ï¼Œçœ‹äº†å‡ ç™¾è¡Œè¾“å‡ºã€‚

ä¸¤å°æ—¶åï¼Œä»–çš„æ¡Œé¢ä¹±æˆä¸€å›¢ã€‚ä»–éœ€è¦åšä¸€ä»¶äº‹ï¼š**æ¸…ç†æ¡Œé¢ï¼Œåªä¿ç•™å½“å‰æœ€éœ€è¦çš„ä¸œè¥¿**ã€‚

AI Agent é¢ä¸´åŒæ ·çš„é—®é¢˜ï¼Œä½†æ›´ä¸¥å³»â€”â€”å®ƒçš„ã€Œæ¡Œé¢ã€æœ‰ç¡¬æ€§ä¸Šé™ã€‚

ä¸Šä¸‹æ–‡çª—å£ï¼ˆContext Windowï¼‰æ˜¯ LLM èƒ½ã€Œçœ‹åˆ°ã€çš„å…¨éƒ¨å†…å®¹ã€‚æ¯æ¬¡ API è°ƒç”¨ï¼Œæ‰€æœ‰å†å²æ¶ˆæ¯éƒ½è¦å¡è¿›å»ã€‚éšç€å¯¹è¯è½®æ¬¡å¢åŠ ï¼Œè¿™ä¸ªçª—å£ä¼šè¢«å¡«æ»¡â€”â€”ç„¶å Agent å°±å¡æ­»äº†ã€‚

`v5_agent.py` ç”¨ä¸‰å±‚å‹ç¼©æµæ°´çº¿è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡é€å±‚è§£ææ¯ä¸€å±‚çš„è®¾è®¡é€»è¾‘ï¼Œä»¥åŠè¿™ä¸ªé—®é¢˜è¿˜æœ‰å“ªäº›å€¼å¾—æ¢ç´¢çš„è§£æ³•ã€‚

---

<a id="part-1"></a>
## ç¬¬ä¸€éƒ¨åˆ†ï¼šç†è®ºåŸºç¡€ ğŸ§ 

<a id="context-window"></a>
### ä¸Šä¸‹æ–‡çª—å£ï¼šAgent çš„å·¥ä½œè®°å¿†

LLM çš„ä¸Šä¸‹æ–‡çª—å£ï¼Œæœ¬è´¨ä¸Šæ˜¯å®ƒçš„**å·¥ä½œè®°å¿†**ã€‚

```
äººç±»å·¥ä½œè®°å¿†:
  - å®¹é‡æœ‰é™ï¼ˆ7Â±2 ä¸ªä¿¡æ¯å—ï¼‰
  - çŸ­æœŸå­˜å‚¨ï¼Œä¸æŒä¹…
  - å½“å‰ä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯ä¼˜å…ˆ

LLM ä¸Šä¸‹æ–‡çª—å£:
  - å®¹é‡æœ‰é™ï¼ˆå‡ ä¸‡åˆ°å‡ åä¸‡ tokensï¼‰
  - æ¯æ¬¡è°ƒç”¨é‡æ–°åŠ è½½
  - çª—å£å†…æ‰€æœ‰å†…å®¹éƒ½ã€Œå¯è§ã€
```

å¯¹äºå•è½®é—®ç­”ï¼Œè¿™ä¸æ˜¯é—®é¢˜ã€‚ä½† Agent æ˜¯**å¤šè½®äº¤äº’**çš„â€”â€”å®ƒéœ€è¦ï¼š

1. è®°ä½ç”¨æˆ·çš„åŸå§‹ä»»åŠ¡
2. è®°ä½å·²ç»åšäº†ä»€ä¹ˆ
3. è®°ä½å·¥å…·è°ƒç”¨çš„ç»“æœ
4. è®°ä½ä¸­é—´å†³ç­–å’Œæ¨ç†

æ¯ä¸€è½®å¯¹è¯ï¼Œè¿™äº›å†…å®¹éƒ½åœ¨ç´¯ç§¯ã€‚

<a id="why-agents-die"></a>
### ä¸ºä»€ä¹ˆ Agent ä¼šã€Œæ’‘æ­»ã€

çœ‹ä¸€ä¸ªå…¸å‹çš„ Agent å¯¹è¯å†å²ç»“æ„ï¼š

```
messages = [
  {role: "user",      content: "å¸®æˆ‘é‡æ„è¿™ä¸ªé¡¹ç›®"},          # 50 tokens
  {role: "assistant", content: [read_file("main.py"), ...]}, # 100 tokens
  {role: "user",      content: [tool_result: "...æ–‡ä»¶å†…å®¹..."]}, # 2000 tokens â† å¤§
  {role: "assistant", content: [grep("TODO"), ...]},          # 80 tokens
  {role: "user",      content: [tool_result: "...æœç´¢ç»“æœ..."]}, # 500 tokens
  {role: "assistant", content: [read_file("utils.py"), ...]}, # 100 tokens
  {role: "user",      content: [tool_result: "...æ–‡ä»¶å†…å®¹..."]}, # 1500 tokens â† å¤§
  ...ï¼ˆç»§ç»­ç´¯ç§¯ï¼‰
]
```

**é—®é¢˜çš„æ ¹æº**ï¼š`tool_result` æ˜¯ä¸Šä¸‹æ–‡è†¨èƒ€çš„ä¸»è¦æ¥æºã€‚

- è¯»ä¸€ä¸ªæ–‡ä»¶ï¼š500-3000 tokens
- è¿è¡Œä¸€æ¡å‘½ä»¤ï¼š100-5000 tokensï¼ˆå–å†³äºè¾“å‡ºï¼‰
- æœç´¢ä»£ç ï¼š200-2000 tokens

ä¸€ä¸ªå¤æ‚ä»»åŠ¡å¯èƒ½éœ€è¦å‡ åæ¬¡å·¥å…·è°ƒç”¨ã€‚æ¯æ¬¡è°ƒç”¨çš„ç»“æœéƒ½ç•™åœ¨ä¸Šä¸‹æ–‡é‡Œï¼Œå³ä½¿è¿™ä¸ªç»“æœåœ¨åç»­æ­¥éª¤ä¸­å·²ç»æ²¡æœ‰ä»·å€¼ã€‚

**å…³é”®æ´å¯Ÿ**ï¼šå¤§å¤šæ•°å·¥å…·è°ƒç”¨ç»“æœåªåœ¨è°ƒç”¨åçš„ 1-3 è½®å†…æœ‰ç”¨ã€‚ä¹‹åï¼Œå®ƒä»¬å°±æ˜¯å™ªéŸ³ã€‚

<a id="strategic-forgetting"></a>
### æˆ˜ç•¥æ€§é—å¿˜ï¼šæ ¸å¿ƒè®¾è®¡æ€æƒ³

è§£å†³æ–¹æ¡ˆä¸æ˜¯ã€Œè®°ä½æ‰€æœ‰ä¸œè¥¿ã€ï¼Œè€Œæ˜¯**æˆ˜ç•¥æ€§é—å¿˜**ã€‚

```
äººç±»ä¸“å®¶å¤„ç†å¤æ‚ä»»åŠ¡çš„æ–¹å¼:
  - ä¸ä¼šè®°ä½æ¯ä¸€è¡Œä»£ç çš„å†…å®¹
  - è®°ä½ã€Œæˆ‘çœ‹è¿‡è¿™ä¸ªæ–‡ä»¶ï¼Œå®ƒåšäº† Xã€
  - è®°ä½å…³é”®å†³ç­–å’Œå‘ç°
  - å½“å‰æ­¥éª¤éœ€è¦ä»€ä¹ˆï¼Œæ‰å»æŸ¥ä»€ä¹ˆ

Agent çš„æˆ˜ç•¥æ€§é—å¿˜:
  - æ—§çš„å·¥å…·ç»“æœ â†’ æ›¿æ¢ä¸ºå ä½ç¬¦ã€Œ[æ›¾ç»ç”¨è¿‡ read_file]ã€
  - æ•´ä¸ªå¯¹è¯ â†’ å‹ç¼©ä¸ºæ‘˜è¦ã€Œå·²å®Œæˆ Xï¼Œå½“å‰çŠ¶æ€ Yï¼Œå…³é”®å†³ç­– Zã€
  - ä¸»åŠ¨è§¦å‘ â†’ åœ¨å…³é”®èŠ‚ç‚¹æ‰‹åŠ¨æ¸…ç†
```

è¿™ä¸æ˜¯ã€Œä¸¢å¤±ä¿¡æ¯ã€ï¼Œè€Œæ˜¯**ç”¨æ›´é«˜å¯†åº¦çš„è¡¨ç¤ºæ›¿æ¢ä½å¯†åº¦çš„åŸå§‹æ•°æ®**ã€‚

---

<a id="part-2"></a>
## ç¬¬äºŒéƒ¨åˆ†ï¼šä¸‰å±‚å‹ç¼©æµæ°´çº¿ âš™ï¸

<a id="pipeline"></a>
### æ•´ä½“æ¶æ„ï¼šä¸‰å±‚æµæ°´çº¿

```
æ¯ä¸€è½® Agent å¾ªç¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚  å·¥å…·è°ƒç”¨ç»“æœè¿½åŠ åˆ° messages                         â”‚
â”‚           â”‚                                         â”‚
â”‚           â–¼                                         â”‚
â”‚  [Layer 1: micro_compact]  â† æ¯è½®é™é»˜æ‰§è¡Œ           â”‚
â”‚    æ—§ tool_result â†’ å ä½ç¬¦                          â”‚
â”‚    æˆæœ¬: æä½ï¼ˆçº¯å­—ç¬¦ä¸²æ›¿æ¢ï¼‰                        â”‚
â”‚           â”‚                                         â”‚
â”‚           â–¼                                         â”‚
â”‚  [æ£€æŸ¥: tokens > 50000?]                            â”‚
â”‚       å¦ â†“        æ˜¯ â†“                              â”‚
â”‚    ç»§ç»­æ‰§è¡Œ   [Layer 2: auto_compact]               â”‚
â”‚               ä¿å­˜å®Œæ•´è®°å½•åˆ° .transcripts/           â”‚
â”‚               LLM ç”Ÿæˆæ‘˜è¦                          â”‚
â”‚               messages æ›¿æ¢ä¸º [æ‘˜è¦]                â”‚
â”‚                      â”‚                              â”‚
â”‚                      â–¼                              â”‚
â”‚              [Layer 3: compact å·¥å…·]                â”‚
â”‚               Agent ä¸»åŠ¨è°ƒç”¨                        â”‚
â”‚               é€»è¾‘åŒ auto_compact                   â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä¸‰å±‚å„æœ‰åˆ†å·¥ï¼Œè¦†ç›–ä¸åŒçš„å‹ç¼©åœºæ™¯ã€‚

<a id="layer1"></a>
### ç¬¬ä¸€å±‚ï¼šmicro_compactï¼ˆé™é»˜æ¸…ç†ï¼‰

**è§£å†³çš„é—®é¢˜**ï¼šæ—§å·¥å…·ç»“æœå ç”¨å¤§é‡ tokenï¼Œä½†å·²æ— ä»·å€¼ã€‚

**è§¦å‘æ—¶æœº**ï¼šæ¯ä¸€è½® LLM è°ƒç”¨å‰ï¼Œè‡ªåŠ¨æ‰§è¡Œï¼Œæ— æ„ŸçŸ¥ã€‚

**åšä»€ä¹ˆ**ï¼šåªæ›¿æ¢æ—§ `tool_result` å—çš„ `content` å­—æ®µâ€”â€”æ¶ˆæ¯æ¡ç›®æœ¬èº«ä¿ç•™ï¼Œassistant çš„æ¨ç†æ–‡æœ¬å®Œæ•´ä¿ç•™ï¼Œåªæœ‰å·¥å…·è¿”å›çš„åŸå§‹å†…å®¹è¢«æ›¿æ¢ä¸ºå ä½ç¬¦ã€‚

```
æ›¿æ¢å‰ï¼ˆtool_result å—çš„ contentï¼‰:
  "def main():\n    parser = argparse.ArgumentParser()\n    parser.add_argument('--model'...ï¼ˆ2000 tokensï¼‰"

æ›¿æ¢åï¼ˆåŒä¸€ä¸ª tool_result å—ï¼Œåªæ¢ contentï¼‰:
  "[Previous: used read_file]"  â† 6 tokens
```

**å‹ç¼©èŒƒå›´çš„è¾¹ç•Œ**ï¼š

```
messages ç»“æ„:
  assistant: "æˆ‘éœ€è¦å…ˆè¯»å– main.py æ¥äº†è§£ç»“æ„"   â† ä¸åŠ¨ï¼ˆæ¨ç†æ–‡æœ¬ï¼‰
             [tool_use: read_file("main.py")]    â† ä¸åŠ¨ï¼ˆå·¥å…·è°ƒç”¨è®°å½•ï¼‰
  user:      [tool_result: content="...2000 tokens..."]  â† åªæ›¿æ¢è¿™é‡Œçš„ content
  assistant: "æ–‡ä»¶åŒ…å« AuthService ç±»ï¼Œæˆ‘æ¥é‡æ„å®ƒ"  â† ä¸åŠ¨ï¼ˆæ¨ç†æ–‡æœ¬ï¼‰
             [tool_use: edit_file(...)]           â† ä¸åŠ¨
  user:      [tool_result: content="Edited auth.py"]     â† ä¿ç•™ï¼ˆæœ€è¿‘ 3 ä¸ªä¹‹å†…ï¼‰
```

micro_compact ä¸åˆ æ¶ˆæ¯ã€ä¸åŠ¨ assistant æ¨ç†ã€ä¸æ”¹æ¶ˆæ¯ç»“æ„â€”â€”å®ƒåªåšä¸€ä»¶äº‹ï¼šæŠŠæ—§ `tool_result` çš„å¤§å—åŸå§‹å†…å®¹æ¢æˆå°å ä½ç¬¦ã€‚

**ä¸ºä»€ä¹ˆåªä¿ç•™æœ€è¿‘ 3 æ¬¡ï¼Ÿ**

Agent çš„æ¨ç†é€šå¸¸ä¾èµ–æœ€è¿‘å‡ æ­¥çš„ç»“æœã€‚æ›´æ—©çš„ç»“æœè¦ä¹ˆå·²ç»è¢« Agent å¤„ç†è¿‡ï¼ˆä¿¡æ¯å·²ç»å†…åŒ–åˆ°åç»­çš„æ¨ç†æ–‡æœ¬ä¸­ï¼‰ï¼Œè¦ä¹ˆå·²ç»ä¸å†ç›¸å…³ã€‚ä¿ç•™ 3 æ¬¡æ˜¯ç»éªŒå€¼ï¼Œå¹³è¡¡äº†ã€Œè®°å¿†æ·±åº¦ã€å’Œã€Œtoken èŠ‚çœã€ã€‚

**ä»£ä»·**ï¼šå¦‚æœ Agent éœ€è¦å›å¤´æŸ¥çœ‹æ—©æœŸçš„å·¥å…·ç»“æœï¼Œå®ƒçœ‹åˆ°çš„æ˜¯å ä½ç¬¦ï¼Œéœ€è¦é‡æ–°è°ƒç”¨å·¥å…·ã€‚è¿™æ˜¯å¯æ¥å—çš„ä»£ä»·â€”â€”é‡æ–°è°ƒç”¨ä¸€æ¬¡å·¥å…·ï¼Œæ¯”ä¸Šä¸‹æ–‡æ’‘æ­»è¦å¥½å¾—å¤šã€‚

<a id="layer2"></a>
### ç¬¬äºŒå±‚ï¼šauto_compactï¼ˆè‡ªåŠ¨æ‘˜è¦ï¼‰

**è§£å†³çš„é—®é¢˜**ï¼šå³ä½¿æœ‰ micro_compactï¼Œé•¿æ—¶é—´è¿è¡Œå token æ€»é‡ä»ä¼šè¶…é™ã€‚

**è§¦å‘æ—¶æœº**ï¼šä¼°ç®— token æ•°è¶…è¿‡é˜ˆå€¼ï¼ˆ50000ï¼‰æ—¶è‡ªåŠ¨è§¦å‘ã€‚

**åšä»€ä¹ˆ**ï¼š
1. æŠŠå®Œæ•´å¯¹è¯å†å²ä¿å­˜åˆ° `.transcripts/` ç›®å½•ï¼ˆä¸ä¸¢å¤±åŸå§‹è®°å½•ï¼‰
2. è°ƒç”¨ LLM ç”Ÿæˆå¯¹è¯æ‘˜è¦ï¼ˆå·²å®Œæˆä»€ä¹ˆã€å½“å‰çŠ¶æ€ã€å…³é”®å†³ç­–ï¼‰
3. ç”¨æ‘˜è¦æ›¿æ¢å…¨éƒ¨ messages

```
æ›¿æ¢å‰:
  messages = [50+ æ¡æ¶ˆæ¯ï¼ŒåŒ…å«å¤§é‡å·¥å…·è°ƒç”¨ç»“æœ]  â† 60000 tokens

æ›¿æ¢å:
  messages = [
    {role: "user",      content: "[å¯¹è¯å·²å‹ç¼©ã€‚è®°å½•: .transcripts/xxx.jsonl]\n\næ‘˜è¦å†…å®¹..."},
    {role: "assistant", content: "å·²ç†è§£ã€‚ç»§ç»­æ‰§è¡Œã€‚"},
  ]  â† ~2000 tokens
```

**å…³é”®è®¾è®¡**ï¼šæ‘˜è¦ç”± LLM ç”Ÿæˆï¼Œè€Œä¸æ˜¯ç®€å•æˆªæ–­ã€‚LLM çŸ¥é“å“ªäº›ä¿¡æ¯å¯¹ç»§ç»­ä»»åŠ¡æœ€é‡è¦â€”â€”å®ƒä¼šä¿ç•™ä»»åŠ¡ç›®æ ‡ã€å·²å®Œæˆçš„æ­¥éª¤ã€å½“å‰çŠ¶æ€ã€å…³é”®å‘ç°ï¼Œè€Œä¸æ˜¯æœºæ¢°åœ°ä¿ç•™æœ€æ–°çš„ N æ¡æ¶ˆæ¯ã€‚

**å®Œæ•´è®°å½•ä¿ç•™**ï¼šåŸå§‹å¯¹è¯å­˜å…¥ `.transcripts/`ï¼Œä¸ä¼šçœŸæ­£ä¸¢å¤±ã€‚è¿™æ˜¯ã€Œå‹ç¼©ã€è€Œéã€Œåˆ é™¤ã€ã€‚

<a id="layer3"></a>
### ç¬¬ä¸‰å±‚ï¼šcompact å·¥å…·ï¼ˆä¸»åŠ¨è§¦å‘ï¼‰

**è§£å†³çš„é—®é¢˜**ï¼šAgent è‡ªå·±æ„ŸçŸ¥åˆ°ä¸Šä¸‹æ–‡ã€Œä¹±äº†ã€ï¼Œéœ€è¦ä¸»åŠ¨æ¸…ç†ã€‚

**è§¦å‘æ—¶æœº**ï¼šAgent ä¸»åŠ¨è°ƒç”¨ `compact` å·¥å…·ã€‚

**åšä»€ä¹ˆ**ï¼šé€»è¾‘ä¸ auto_compact ç›¸åŒï¼Œä½†ç”± Agent è‡ªä¸»å†³ç­–è§¦å‘ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€å±‚ï¼Ÿ**

auto_compact æ˜¯è¢«åŠ¨çš„â€”â€”å®ƒç­‰åˆ° token è¶…é™æ‰è§¦å‘ã€‚ä½†æœ‰æ—¶ Agent åœ¨ token æœªè¶…é™æ—¶å°±æ„è¯†åˆ°ä¸Šä¸‹æ–‡å·²ç»ã€Œæ··ä¹±ã€äº†ï¼š

- ä»»åŠ¡é˜¶æ®µåˆ‡æ¢ï¼ˆä»ã€Œæ¢ç´¢ã€åˆ°ã€Œå®ç°ã€ï¼‰
- å®Œæˆäº†ä¸€ä¸ªå¤§çš„å­ä»»åŠ¡ï¼Œå‡†å¤‡å¼€å§‹ä¸‹ä¸€ä¸ª
- ä¸Šä¸‹æ–‡é‡Œæœ‰å¤§é‡ä¸å†ç›¸å…³çš„ä¿¡æ¯

è¿™æ—¶ Agent å¯ä»¥ä¸»åŠ¨è°ƒç”¨ `compact`ï¼Œåœ¨ã€Œåˆé€‚çš„æ—¶æœºã€å‹ç¼©ï¼Œè€Œä¸æ˜¯ç­‰åˆ°ã€Œä¸å¾—ä¸å‹ç¼©ã€ã€‚

è¿™ä½“ç°äº†ä¸€ä¸ªè®¾è®¡å“²å­¦ï¼š**ç»™ Agent è‡ªä¸»ç®¡ç†è®°å¿†çš„èƒ½åŠ›**ï¼Œè€Œä¸æ˜¯å®Œå…¨ä¾èµ–å¤–éƒ¨æœºåˆ¶ã€‚

<a id="cooperation"></a>
### ä¸‰å±‚åä½œï¼šå„å¸å…¶èŒ

```
é—®é¢˜ç»´åº¦          è§£å†³å±‚æ¬¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ—§å·¥å…·ç»“æœå ç©ºé—´  â†’ Layer 1: micro_compactï¼ˆæ¯è½®é™é»˜ï¼‰
æ€»é‡è¶…é™          â†’ Layer 2: auto_compactï¼ˆé˜ˆå€¼è§¦å‘ï¼‰
ä¸»åŠ¨æ¸…ç†æ—¶æœº      â†’ Layer 3: compact å·¥å…·ï¼ˆAgent è‡ªä¸»ï¼‰

è§¦å‘æ–¹å¼          æˆæœ¬      æ•ˆæœ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
micro_compact    æä½      æ¸è¿›å¼ï¼Œæ¯è½®å°å¹…å‡å°‘
auto_compact     ä¸­ç­‰      ä¸€æ¬¡æ€§å¤§å¹…å‹ç¼©
compact å·¥å…·     ä¸­ç­‰      Agent è‡ªä¸»å†³ç­–æ—¶æœº
```

ä¸‰å±‚ä¸æ˜¯äº’æ–¥çš„ï¼Œè€Œæ˜¯äº’è¡¥çš„ï¼šmicro_compact æŒç»­ã€Œå°æ‰«é™¤ã€ï¼Œauto_compact åœ¨å¿…è¦æ—¶ã€Œå¤§æ‰«é™¤ã€ï¼Œcompact å·¥å…·è®© Agent åœ¨åˆé€‚æ—¶æœºã€Œä¸»åŠ¨æ•´ç†ã€ã€‚

---

<a id="part-3"></a>
## ç¬¬ä¸‰éƒ¨åˆ†ï¼šä»£ç å®ç° ğŸ’»

<a id="token-estimate"></a>
### token ä¼°ç®—

```python
def estimate_tokens(messages: list) -> int:
    """Rough token count: ~4 chars per token."""
    return len(str(messages)) // 4
```

è¿™æ˜¯ä¸€ä¸ªç²—ç•¥ä¼°ç®—ï¼šæŠŠ messages åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œé™¤ä»¥ 4ï¼ˆè‹±æ–‡çº¦ 4 å­—ç¬¦/tokenï¼Œä¸­æ–‡çº¦ 1.5 å­—ç¬¦/tokenï¼‰ã€‚

ä¸ç²¾ç¡®ï¼Œä½†è¶³å¤Ÿç”¨â€”â€”è§¦å‘é˜ˆå€¼è®¾ä¸º 50000ï¼Œå®é™…ä¸Šä¸‹æ–‡å¯èƒ½åœ¨ 40000-60000 ä¹‹é—´ï¼Œæœ‰è¶³å¤Ÿçš„ç¼“å†²åŒºã€‚ç²¾ç¡®è®¡ç®—éœ€è¦è°ƒç”¨ tokenizerï¼Œæˆæœ¬æ›´é«˜ï¼Œå¯¹è¿™ä¸ªåœºæ™¯ä¸å€¼å¾—ã€‚

<a id="micro-compact-code"></a>
### micro_compact å®ç°

```python
KEEP_RECENT = 3  # ä¿ç•™æœ€è¿‘ N æ¬¡å·¥å…·ç»“æœ

def micro_compact(messages: list) -> list:
    """Layer 1: replace old tool results with placeholders."""
    # æ”¶é›†æ‰€æœ‰ tool_result çš„ä½ç½®
    tool_results = []
    for msg_idx, msg in enumerate(messages):
        if msg["role"] == "user" and isinstance(msg.get("content"), list):
            for part_idx, part in enumerate(msg["content"]):
                if isinstance(part, dict) and part.get("type") == "tool_result":
                    tool_results.append((msg_idx, part_idx, part))

    if len(tool_results) <= KEEP_RECENT:
        return messages  # ä¸å¤Ÿå¤šï¼Œä¸éœ€è¦å‹ç¼©

    # å»ºç«‹ tool_use_id â†’ tool_name çš„æ˜ å°„ï¼ˆç”¨äºç”Ÿæˆæœ‰æ„ä¹‰çš„å ä½ç¬¦ï¼‰
    tool_name_map = {}
    for msg in messages:
        if msg["role"] == "assistant":
            content = msg.get("content", [])
            if isinstance(content, list):
                for block in content:
                    if hasattr(block, "type") and block.type == "tool_use":
                        tool_name_map[block.id] = block.name

    # æ›¿æ¢æ—§ç»“æœï¼ˆä¿ç•™æœ€è¿‘ KEEP_RECENT ä¸ªï¼‰
    to_clear = tool_results[:-KEEP_RECENT]
    for _, _, result in to_clear:
        if isinstance(result.get("content"), str) and len(result["content"]) > 100:
            tool_id = result.get("tool_use_id", "")
            tool_name = tool_name_map.get(tool_id, "unknown")
            result["content"] = f"[Previous: used {tool_name}]"

    return messages
```

æ³¨æ„ä¸¤ä¸ªç»†èŠ‚ï¼š
1. **åªæ›¿æ¢é•¿å†…å®¹**ï¼ˆ`len > 100`ï¼‰ï¼šçŸ­ç»“æœï¼ˆå¦‚ `"Wrote 42 bytes"`ï¼‰æœ¬èº«å°±å¾ˆå°ï¼Œæ›¿æ¢æ²¡æœ‰æ„ä¹‰ã€‚
2. **å ä½ç¬¦åŒ…å«å·¥å…·å**ï¼š`[Previous: used read_file]` æ¯” `[cleared]` æ›´æœ‰ä¿¡æ¯é‡ï¼ŒAgent çŸ¥é“ã€Œæˆ‘æ›¾ç»è¯»è¿‡ä¸€ä¸ªæ–‡ä»¶ã€ã€‚

<a id="auto-compact-code"></a>
### auto_compact å®ç°

```python
TRANSCRIPT_DIR = WORKDIR / ".transcripts"

def auto_compact(messages: list) -> list:
    """Layer 2: save transcript, summarize, replace messages."""
    # 1. ä¿å­˜å®Œæ•´è®°å½•
    TRANSCRIPT_DIR.mkdir(exist_ok=True)
    transcript_path = TRANSCRIPT_DIR / f"transcript_{int(time.time())}.jsonl"
    with open(transcript_path, "w") as f:
        for msg in messages:
            f.write(json.dumps(msg, default=str) + "\n")
    print(f"[transcript saved: {transcript_path}]")

    # 2. è°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦
    conversation_text = json.dumps(messages, default=str)[:80000]
    response = client.messages.create(
        model=MODEL,
        messages=[{"role": "user", "content":
            "Summarize this conversation for continuity. Include: "
            "1) What was accomplished, 2) Current state, 3) Key decisions made. "
            "Be concise but preserve critical details.\n\n" + conversation_text}],
        max_tokens=2000,
    )
    summary = response.content[0].text

    # 3. ç”¨æ‘˜è¦æ›¿æ¢å…¨éƒ¨ messages
    return [
        {"role": "user", "content": f"[Conversation compressed. Transcript: {transcript_path}]\n\n{summary}"},
        {"role": "assistant", "content": "Understood. I have the context from the summary. Continuing."},
    ]
```

æ‘˜è¦ prompt çš„ä¸‰ä¸ªè¦ç´ ï¼š**å·²å®Œæˆä»€ä¹ˆã€å½“å‰çŠ¶æ€ã€å…³é”®å†³ç­–**ã€‚è¿™ä¸‰ç‚¹è¶³ä»¥è®© Agent åœ¨å‹ç¼©åç»§ç»­å·¥ä½œï¼Œä¸ä¼šã€Œå¤±å¿†ã€ã€‚

<a id="main-loop"></a>
### ä¸»å¾ªç¯ä¸­çš„å‹ç¼©è°ƒåº¦

```python
def agent_loop(messages: list) -> list:
    while True:
        # Layer 1: æ¯è½®é™é»˜æ‰§è¡Œ
        micro_compact(messages)

        # Layer 2: token è¶…é™æ—¶è‡ªåŠ¨è§¦å‘
        if estimate_tokens(messages) > THRESHOLD:
            print("[auto_compact triggered]")
            messages[:] = auto_compact(messages)

        response = client.messages.create(...)

        # ... å¤„ç†å·¥å…·è°ƒç”¨ ...

        # Layer 3: Agent ä¸»åŠ¨è§¦å‘
        if manual_compact:
            print("[manual compact]")
            messages[:] = auto_compact(messages)
```

è°ƒåº¦é€»è¾‘æ¸…æ™°ï¼šLayer 1 æ— æ¡ä»¶æ‰§è¡Œï¼ŒLayer 2 æ¡ä»¶è§¦å‘ï¼ŒLayer 3 ç”± Agent å†³ç­–è§¦å‘ã€‚

---

<a id="part-4"></a>
## ç¬¬å››éƒ¨åˆ†ï¼šå…¶ä»–å‹ç¼©æ–¹å‘ ğŸ”­

v5_agent.py çš„ä¸‰å±‚å‹ç¼©è§£å†³äº†æ ¸å¿ƒé—®é¢˜ï¼Œä½†è¿™ä¸ªé¢†åŸŸè¿˜æœ‰å¾ˆå¤šå€¼å¾—æ¢ç´¢çš„æ–¹å‘ã€‚

<a id="structured-memory"></a>
### æ–¹å‘ä¸€ï¼šç»“æ„åŒ–è®°å¿†æå–

**ç°æœ‰æ–¹æ¡ˆçš„å±€é™**ï¼šauto_compact ç”Ÿæˆçš„æ˜¯è‡ªç”±æ–‡æœ¬æ‘˜è¦ï¼ŒAgent éœ€è¦ä»æ‘˜è¦ä¸­ã€Œé‡æ–°ç†è§£ã€çŠ¶æ€ã€‚

**æ”¹è¿›æ€è·¯**ï¼šæŠŠæ‘˜è¦ç»“æ„åŒ–ã€‚

```python
# ä¸æ˜¯è‡ªç”±æ–‡æœ¬æ‘˜è¦ï¼Œè€Œæ˜¯ç»“æ„åŒ–çŠ¶æ€
structured_memory = {
    "task": "é‡æ„ auth æ¨¡å—",
    "completed": [
        "è¯»å–äº† auth.pyï¼ˆä¸»è¦é€»è¾‘åœ¨ AuthService ç±»ï¼‰",
        "å‘ç° 3 ä¸ª TODO æ³¨é‡Š",
        "ç¡®è®¤æµ‹è¯•è¦†ç›–ç‡ 62%"
    ],
    "current_step": "é‡å†™ AuthService.validate() æ–¹æ³•",
    "key_findings": {
        "auth.py": "åŒ…å« AuthService, TokenManager ä¸¤ä¸ªç±»",
        "tests/test_auth.py": "ç¼ºå°‘è¾¹ç•Œæ¡ä»¶æµ‹è¯•"
    },
    "pending": [
        "æ›´æ–°æµ‹è¯•",
        "æ›´æ–°æ–‡æ¡£"
    ]
}
```

**ä¼˜åŠ¿**ï¼šAgent å¯ä»¥ç›´æ¥æŸ¥è¯¢ç»“æ„åŒ–çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä»è‡ªç”±æ–‡æœ¬ä¸­æå–ä¿¡æ¯ã€‚å‹ç¼©åçš„ã€Œè®°å¿†ã€æ›´å¯é ï¼Œæ›´ä¸å®¹æ˜“äº§ç”Ÿå¹»è§‰ã€‚

**ä»£ä»·**ï¼šéœ€è¦è®¾è®¡æ‘˜è¦ schemaï¼Œå‹ç¼©é€»è¾‘æ›´å¤æ‚ã€‚

<a id="dedup"></a>
### æ–¹å‘äºŒï¼šå·¥å…·ç»“æœå»é‡ä¸å¢é‡æ›´æ–°

**ç°æœ‰æ–¹æ¡ˆçš„å±€é™**ï¼šåŒä¸€ä¸ªæ–‡ä»¶å¯èƒ½è¢«è¯»å–å¤šæ¬¡ï¼Œæ¯æ¬¡éƒ½ç•™ä¸‹å®Œæ•´å†…å®¹ã€‚

**æ”¹è¿›æ€è·¯**ï¼šæ£€æµ‹é‡å¤ï¼Œåªä¿ç•™æœ€æ–°ç‰ˆæœ¬ã€‚

```python
def dedup_tool_results(messages: list) -> list:
    """å¦‚æœåŒä¸€ä¸ªæ–‡ä»¶è¢«è¯»å–å¤šæ¬¡ï¼Œåªä¿ç•™æœ€æ–°çš„ç»“æœã€‚"""
    seen_reads = {}  # path â†’ (msg_idx, part_idx)

    for msg_idx, msg in enumerate(messages):
        if msg["role"] == "assistant":
            for block in msg.get("content", []):
                if hasattr(block, "type") and block.type == "tool_use":
                    if block.name == "read_file":
                        path = block.input.get("path")
                        if path in seen_reads:
                            # æ¸…é™¤æ—§çš„è¯»å–ç»“æœ
                            old_idx, old_part = seen_reads[path]
                            messages[old_idx]["content"][old_part]["content"] = \
                                f"[Superseded by later read of {path}]"
                        seen_reads[path] = (msg_idx + 1, ...)  # è®°å½•æ–°ä½ç½®
    return messages
```

**é€‚ç”¨åœºæ™¯**ï¼šAgent åœ¨ç¼–è¾‘æ–‡ä»¶åé‡æ–°è¯»å–éªŒè¯â€”â€”æ—§çš„è¯»å–ç»“æœå·²ç»è¿‡æ—¶ï¼Œå¯ä»¥å®‰å…¨æ¸…é™¤ã€‚

<a id="tiered-storage"></a>
### æ–¹å‘ä¸‰ï¼šåˆ†å±‚å­˜å‚¨ï¼ˆçƒ­/å†·æ•°æ®åˆ†ç¦»ï¼‰

**ç°æœ‰æ–¹æ¡ˆçš„å±€é™**ï¼šæ‰€æœ‰ä¿¡æ¯è¦ä¹ˆåœ¨ä¸Šä¸‹æ–‡é‡Œï¼ˆçƒ­ï¼‰ï¼Œè¦ä¹ˆè¢«å‹ç¼©æ‰ï¼ˆå†·ï¼‰ã€‚æ²¡æœ‰ä¸­é—´çŠ¶æ€ã€‚

**æ”¹è¿›æ€è·¯**ï¼šå¼•å…¥ã€Œæ¸©æ•°æ®ã€å±‚â€”â€”ä¸åœ¨ä¸Šä¸‹æ–‡é‡Œï¼Œä½†å¯ä»¥æŒ‰éœ€æ£€ç´¢ã€‚

```
çƒ­æ•°æ®ï¼ˆä¸Šä¸‹æ–‡ï¼‰:   å½“å‰æ­¥éª¤ç›´æ¥éœ€è¦çš„ä¿¡æ¯
æ¸©æ•°æ®ï¼ˆå¤–éƒ¨å­˜å‚¨ï¼‰: å¯èƒ½éœ€è¦ä½†ä¸ç¡®å®šçš„ä¿¡æ¯
å†·æ•°æ®ï¼ˆå½’æ¡£ï¼‰:     å·²å®Œæˆæ­¥éª¤çš„å®Œæ•´è®°å½•

çƒ­ â†’ æ¸©: micro_compact è§¦å‘ï¼Œç»“æœå­˜å…¥å‘é‡æ•°æ®åº“
æ¸© â†’ çƒ­: Agent è°ƒç”¨ recall_memory("auth module") æ£€ç´¢
å†·:      auto_compact çš„ transcript æ–‡ä»¶
```

è¿™æœ¬è´¨ä¸Šæ˜¯ç»™ Agent åŠ ä¸€ä¸ª**å¤–éƒ¨è®°å¿†ç³»ç»Ÿ**ã€‚Agent ä¸éœ€è¦è®°ä½æ‰€æœ‰ç»†èŠ‚ï¼Œä½†å¯ä»¥åœ¨éœ€è¦æ—¶ã€Œæƒ³èµ·æ¥ã€ã€‚

**å®ç°å¤æ‚åº¦**ï¼šéœ€è¦å‘é‡æ•°æ®åº“ï¼ˆå¦‚ ChromaDBï¼‰å’Œæ£€ç´¢å·¥å…·ï¼Œæ¯”ç°æœ‰æ–¹æ¡ˆå¤æ‚å¾—å¤šã€‚ä½†å¯¹äºéœ€è¦é•¿æ—¶é—´è¿è¡Œçš„ Agentï¼ˆå‡ å°æ—¶ç”šè‡³å‡ å¤©ï¼‰ï¼Œè¿™ä¸ªæŠ•å…¥æ˜¯å€¼å¾—çš„ã€‚

<a id="semantic-compression"></a>
### æ–¹å‘å››ï¼šè¯­ä¹‰å‹ç¼©ï¼ˆè€Œéæˆªæ–­ï¼‰

**ç°æœ‰æ–¹æ¡ˆçš„å±€é™**ï¼šmicro_compact æ˜¯åŸºäºä½ç½®çš„å‹ç¼©ï¼ˆä¿ç•™æœ€è¿‘ N ä¸ªï¼‰ï¼Œä¸è€ƒè™‘å†…å®¹çš„è¯­ä¹‰é‡è¦æ€§ã€‚

**æ”¹è¿›æ€è·¯**ï¼šåŸºäºè¯­ä¹‰é‡è¦æ€§å†³å®šä¿ç•™ä»€ä¹ˆã€‚

```python
def semantic_compact(messages: list, current_task: str) -> list:
    """
    æ ¹æ®ä¸å½“å‰ä»»åŠ¡çš„ç›¸å…³æ€§ï¼Œå†³å®šå“ªäº›å·¥å…·ç»“æœå€¼å¾—ä¿ç•™ã€‚
    """
    # å¯¹æ¯ä¸ªå·¥å…·ç»“æœï¼Œè¯„ä¼°ä¸å½“å‰ä»»åŠ¡çš„ç›¸å…³æ€§
    for result in tool_results:
        relevance = estimate_relevance(result["content"], current_task)
        if relevance < THRESHOLD:
            result["content"] = f"[Low relevance: used {result['tool_name']}]"
```

**ä¾‹å­**ï¼šAgent æ­£åœ¨ä¿®å¤ä¸€ä¸ª CSS bugï¼Œä¹‹å‰è¯»å–çš„ Python æ–‡ä»¶å†…å®¹ç›¸å…³æ€§ä½ï¼Œå¯ä»¥ä¼˜å…ˆå‹ç¼©ï¼›è€Œè¯»å–çš„ CSS æ–‡ä»¶å†…å®¹ç›¸å…³æ€§é«˜ï¼Œåº”è¯¥ä¿ç•™ã€‚

**ä»£ä»·**ï¼šéœ€è¦é¢å¤–çš„ LLM è°ƒç”¨æ¥è¯„ä¼°ç›¸å…³æ€§ï¼Œæˆ–è€…ç”¨åµŒå…¥å‘é‡è®¡ç®—ç›¸ä¼¼åº¦ã€‚å¯¹äºé«˜é¢‘å‹ç¼©åœºæ™¯ï¼Œæˆæœ¬å¯èƒ½ä¸åˆ’ç®—ã€‚

---

<a id="faq"></a>
## å¸¸è§é—®é¢˜ FAQ

**Q: å‹ç¼©å Agent ä¼šã€Œå¿˜è®°ã€é‡è¦ä¿¡æ¯å—ï¼Ÿ**

A: æœ‰å¯èƒ½ï¼Œä½†è®¾è®¡ä¸Šå°½é‡é¿å…ã€‚auto_compact çš„æ‘˜è¦ prompt æ˜ç¡®è¦æ±‚ä¿ç•™ã€Œå…³é”®å†³ç­–ã€å’Œã€Œå½“å‰çŠ¶æ€ã€ã€‚micro_compact åªæ¸…é™¤æ—§çš„å·¥å…·ç»“æœï¼Œä¸æ¸…é™¤ Agent çš„æ¨ç†æ–‡æœ¬ï¼ˆassistant æ¶ˆæ¯ï¼‰ã€‚å®Œæ•´è®°å½•ä¹Ÿä¿å­˜åœ¨ `.transcripts/` é‡Œï¼Œå¯ä»¥äººå·¥æŸ¥é˜…ã€‚

**Q: THRESHOLD è®¾ä¸º 50000 åˆç†å—ï¼Ÿ**

A: è¿™å–å†³äºä½¿ç”¨çš„æ¨¡å‹ã€‚Claude Sonnet çš„ä¸Šä¸‹æ–‡çª—å£æ˜¯ 200K tokensï¼Œ50000 æ˜¯ 25%ã€‚è®¾ç½®è¿™ä¹ˆä½æ˜¯ä¸ºäº†ç»™åç»­å¯¹è¯ç•™è¶³ç©ºé—´ï¼Œé¿å…åœ¨ä»»åŠ¡è¿›è¡Œåˆ°ä¸€åŠæ—¶çªç„¶è§¦å‘å‹ç¼©ã€‚å¯ä»¥æ ¹æ®å®é™…ä»»åŠ¡è°ƒæ•´ã€‚

**Q: ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨æ›´å¤§çš„ä¸Šä¸‹æ–‡çª—å£ï¼Œè€Œè¦å‹ç¼©ï¼Ÿ**

A: ä¸¤ä¸ªåŸå› ã€‚ç¬¬ä¸€ï¼Œæ›´å¤§çš„ä¸Šä¸‹æ–‡æ„å‘³ç€æ›´é«˜çš„ API æˆæœ¬â€”â€”æ¯æ¬¡è°ƒç”¨éƒ½è¦ä»˜æ‰€æœ‰ token çš„è´¹ç”¨ã€‚ç¬¬äºŒï¼Œç ”ç©¶è¡¨æ˜ LLM åœ¨è¶…é•¿ä¸Šä¸‹æ–‡ä¸­çš„æ³¨æ„åŠ›ä¼šåˆ†æ•£ï¼Œã€ŒLost in the Middleã€é—®é¢˜â€”â€”ä¸­é—´çš„ä¿¡æ¯å®¹æ˜“è¢«å¿½ç•¥ã€‚å‹ç¼©ä¸åªæ˜¯çœé’±ï¼Œä¹Ÿæ˜¯æå‡è´¨é‡ã€‚

**Q: compact å·¥å…·ä»€ä¹ˆæ—¶å€™åº”è¯¥ä¸»åŠ¨è°ƒç”¨ï¼Ÿ**

A: å‡ ä¸ªå…¸å‹åœºæ™¯ï¼šå®Œæˆä¸€ä¸ªå¤§çš„å­ä»»åŠ¡å‡†å¤‡å¼€å§‹ä¸‹ä¸€ä¸ªã€ä»»åŠ¡æ–¹å‘å‘ç”Ÿé‡å¤§è½¬å˜ã€ä¸Šä¸‹æ–‡é‡Œæœ‰å¤§é‡å·²ç»ä¸ç›¸å…³çš„æ¢ç´¢æ€§å·¥å…·è°ƒç”¨ã€‚Agent éœ€è¦å­¦ä¼šåˆ¤æ–­ã€Œç°åœ¨æ˜¯æ•´ç†è®°å¿†çš„å¥½æ—¶æœºã€ã€‚

---

## ğŸ“ ç»“è¯­

ä¸‰å±‚å‹ç¼©æµæ°´çº¿çš„è®¾è®¡ï¼Œä½“ç°äº†ä¸€ä¸ªæ ¸å¿ƒæ€æƒ³ï¼š

```
ä¸åŒçš„å‹ç¼©é—®é¢˜ï¼Œéœ€è¦ä¸åŒç²’åº¦çš„è§£æ³•

æ—§å·¥å…·ç»“æœï¼ˆé«˜é¢‘ã€å°é‡ï¼‰â†’ micro_compactï¼ˆè½»é‡ã€æ¯è½®ï¼‰
æ€»é‡è¶…é™ï¼ˆä½é¢‘ã€å¤§é‡ï¼‰  â†’ auto_compactï¼ˆé‡é‡ã€æŒ‰éœ€ï¼‰
ä¸»åŠ¨æ•´ç†ï¼ˆAgent è‡ªä¸»ï¼‰  â†’ compact å·¥å…·ï¼ˆçµæ´»ã€å¯æ§ï¼‰
```

è¿™å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†å¼‚æ›²åŒå·¥ï¼šæœ‰é¡µé¢ç½®æ¢ï¼ˆmicro_compactï¼‰ã€æœ‰ swapï¼ˆauto_compactï¼‰ã€æœ‰ä¸»åŠ¨é‡Šæ”¾ï¼ˆcompact å·¥å…·ï¼‰ã€‚

æ›´æ·±å±‚çš„æ´å¯Ÿæ˜¯ï¼š**Agent éœ€è¦ç®¡ç†è‡ªå·±çš„è®°å¿†**ã€‚ä¸æ˜¯æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½è®°ä½ï¼Œè€Œæ˜¯çŸ¥é“ä»€ä¹ˆæ—¶å€™è¯¥è®°ã€ä»€ä¹ˆæ—¶å€™è¯¥å¿˜ã€å¿˜äº†ä¹‹åæ€ä¹ˆæ‰¾å›æ¥ã€‚

è¿™æ˜¯è®© Agent èƒ½ã€Œæ°¸è¿œå·¥ä½œä¸‹å»ã€çš„å…³é”®èƒ½åŠ›ã€‚

**ç³»åˆ—å¯¼èˆª**ï¼š
- **ä¸Šä¸€ç¯‡**: [05 - ç”¨çº¯æ–‡æœ¬æ–‡ä»¶æ•™ä¼š Agent ä»»ä½•æŠ€èƒ½ï¼ˆSkillsï¼‰](./005-skill-loading.md)
- **å½“å‰**:   [06 - Agent å¦‚ä½•ã€Œæˆ˜ç•¥æ€§é—å¿˜ã€ï¼ˆä¸Šä¸‹æ–‡å‹ç¼©ï¼‰]()
- **ä¸‹ä¸€ç¯‡**: 07 - å¤šAgent ä»»åŠ¡ç®¡ç†
